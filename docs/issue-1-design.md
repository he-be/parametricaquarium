# Issue #1: 仕様書とMVP作成

このドキュメントは、GitHub Issue #1 の内容に基づいて作成されています。

## Webアプリケーション仕様書: Parametric Aquarium

### 1. 概要
本ドキュメントは、パラメトリックアニメーション技術を用いて、リアルタイムでインタラクティブな2D水槽（見下ろし視点）をシミュレートするWebアプリケーション「Parametric Aquarium」の開発仕様を定義する。

利用者は、物理法則と内部AIに基づいて自律的に泳ぐ、ミニマルなベクターグラフィックの魚を鑑賞し、クリックで波紋を立てるインタラクションを行う。本アプリケーションは、Cloudflare Workers上にデプロイされ、グローバルに高速配信されることを目指す。

### 2. プロジェクト目標
- **中心表現の追求**: 物理ベースの骨格モデルによる、生命感あふれる魚の遊泳アニメーションを最高の品質で実現する。
- **ミニマルな美学**: 極限までシンプル化された背景と、魚および波紋という要素にフォーカスした、詩的で静かな視覚体験を創出する。
- **依存関係を最小化**: ゲームエンジンは使用しない。
- **直感的なインタラクション**: ユーザーのクリックが「波紋」として世界に影響を与える、シンプルで心地よいフィードバックを提供する。

### 3. 技術スタック
- **フロントエンド / メインロジック**:
  - 言語: TypeScript
- **バックエンド / 配信**:
  - ランタイム: Cloudflare Workers (Node.js API互換)
- **ビルド・開発ツール**:
  - パッケージ管理: npm または yarn
  - ビルドツール: Vite または webpack
  - デプロイツール: Wrangler (Cloudflare CLI)

### 4. アーキテクチャ
クライアントヘビーなアーキテクチャを採用。物理シミュレーション、AI、レンダリングの全処理はクライアントサイド（ブラウザ）で実行する。Cloudflare Workerの責務は、静的ファイル（HTML, CSS, JS）の高速配信に限定する。

### 5. 機能仕様
#### 5.1. メインビュー
- **背景**: 単一のフラットな色（例：深い藍色 #2c3e50）でキャンバス全体を塗りつぶす。模様やテクスチャは一切使用しない。
- **環境オブジェクト**: ユーザーのクリックによって生成される「波紋」のみとする。

#### 5.2. パラメトリック魚 (トップダウンビュー)
- **基本構造**: 連結された**ノード(Node)**の集合体（スケルトン）として定義。
- **物理モデル**: Position-Based Dynamics (PBD)を採用し、距離拘束と角度拘束を処理。各ノードは水の抗力（速度に逆らう力）を受ける。
- **推進メカニズム**: 目標角度(i, t) = A * sin(k * i - ω * t) の進行波モデルに基づき、各関節が目標角度に追従しようとすることで推進力を生む。このS字の動きがトップダウンビューで観察される。
- **形状生成**: スケルトンに基づき、真上から見た際の体幅を定義するプロファイル関数を用いてアウトラインを生成。胴体ノードの左右には遊泳を補助する胸ビレを追加し、本体の動きに合わせてアニメーションさせる。
- **AI (行動)**: 先頭ノード（頭部）が魚全体の行動を決定。通常時はランダムに遊泳し、波紋（振動）を検知するとその発生源に興味を示す。

#### 5.3. ユーザーインタラクション
ユーザーが画面をクリック/タップすると、その地点を中心に波紋が広がる。この波紋の発生が、魚のAIに対するトリガー（餌の代わり）となる。

#### 5.4. 波紋の描画ロジック
- **データ構造**: 波紋は、origin(座標), createdAt(生成時刻), maxRadius, duration 等のパラメータを持つ独立したオブジェクトとして管理される。
- **アニメーション**: age = time - createdAtに基づき、半径は線形に拡大 (radius = maxRadius * (age/duration))、透明度はサイン波 (alpha = sin(PI * (age/duration))) を用いてフェードイン・フェードアウトする。

### 6. 非機能仕様
- **レスポンシブ対応**: ウィンドウサイズに応じて、アスペクト比を保ったまま拡大・縮小表示。

### 7. データモデル (TypeScript)
```typescript
// 2次元ベクトル
interface Vector2 { x: number; y: number; }

// 骨格ノード
interface Node { position: Vector2; prevPosition: Vector2; }

// 波紋オブジェクト
interface Ripple {
    origin: Vector2;
    createdAt: number;
    maxRadius: number;
    duration: number;
    lineWidth: number;
    color: number;
}

// 魚の個性パラメータ
interface FishParameters { /* ... 形状、色彩、動きのパラメータ ... */ }

// 魚クラス
class Fish { /* ... nodes, params, update(), draw() ... */ }

// ワールドの状態
interface WorldState {
    rippleOrigins: Vector2[];
    bounds: { width: number, height: number };
}
```

### 8. Cloudflare Workers デプロイメント
wrangler CLIを用い、ビルドツールでバンドルされた静的アセットをCloudflareのグローバルネットワークにデプロイする。

### 9. 開発マイルストーン
- **コア実装**: 静的な魚1匹の描画と、クリックによる波紋の描画を実装。
- **アニメーション実装**: 魚の物理ベース遊泳アニメーションを実装。
- **インタラクション実装**: 魚が波紋に反応するAIを実装。
- **エコシステム拡張**: 複数匹の魚を動的に生成・管理するシステムを構築。
- **デプロイ**: Cloudflare Workersへのデプロイと最適化。

### 10. 将来的な拡張案
- ユーザーが魚のパラメータを調整できるカスタマイズUI。
- Boidsアルゴリズムによる、より高度な魚群のシミュレーション。
- デザインした魚のパラメータをURLで共有する機能。

## MVP (Minimum Viable Product) 開発指示書

### A. MVPの目的
**「1匹の魚が自律的に泳ぎ、ユーザーのクリックに反応して波紋が広がる、という中心的な視覚体験を最小構成で実現すること」**を目的とする。まずは最も重要な2つの要素が技術的に可能で、かつ魅力的に見えることを検証する。

### B. MVPのスコープ（対象範囲）
#### 含めるもの (IN)
- 単一のフラットな色の背景。
- 1匹だけの魚インスタンス（パラメータはコードに直接記述）。
- 物理ベースの遊泳アニメーション（S字にしなって泳ぐ動き）。
- マウスクリックで、その場に波紋が生成される機能。
- 波紋が時間経過で拡大し、フェードアウトするアニメーション。

#### 含めないもの (OUT)
- 複数の魚、およびその管理機能。
- 魚が波紋に反応するAIロジック（MVPでは、魚と波紋は互いに干渉しない）。
- パラメータのランダム化やユーザーによるカスタマイズ機能。
- Cloudflare Workersへのデプロイ（ローカル開発環境での動作確認をゴールとする）。

### C. 開発ステップ
1. **環境構築**:
   - npm (or yarn) を初期化し、typescript, viteをインストールする。
   - tsconfig.json と vite.config.ts を設定する。
2. **シーンの初期化**:
   - index.html を作成し、スクリプトを読み込む。
   - TypeScriptファイル内でPixiJSアプリケーションを初期化し、指定した単一色で背景を塗りつぶす。
3. **【Step 1】波紋の実装**:
   - Rippleインターフェースと、アクティブな波紋を管理する配列 activeRipples を定義する。
   - マウスクリックイベントをリッスンし、クリック位置に新しいRippleオブジェクトを生成して配列に追加する。
   - PixiJSのメインループ（app.ticker）内で、activeRipples を走査し、各波紋の更新（半径、透明度）と描画を行うロジックを実装する。まずこの機能単体が動くことを目指す。
4. **【Step 2】魚の実装（描画まで）**:
   - Node, Fish のクラス（またはインターフェース）を定義する。
   - 1匹分の魚のパラメータを定数としてハードコーディングする。
   - Fish のコンストラクタで、パラメータに基づいてノード群を一直線に生成する。
   - Fish.draw() メソッドを実装する。ノード位置からアウトラインを計算し、PIXI.Graphicsで描画する。この時点では魚は静止している。
5. **【Step 3】魚のアニメーション実装**:
   - Fish.update() メソッドを実装する。これが最重要かつ最難関のステップ。
     - a. 推進力: 進行波モデル (A*sin(k*i-ω*t)) に基づき、各関節の「目標角度」を毎フレーム計算する。
     - b. 物理演算: PBDの考え方に基づき、全ノードの位置を更新するループを実装する。このループ内で「距離拘束」と「角度拘束」（目標角度に近づける力を含む）を解決する。
     - c. 前進: 頭部ノードに、一定の基本的な前進力を与える。
   - メインループで fish.update() と fish.draw() を呼び出すようにする。

### D. MVP完了の定義
以下の3点がすべて満たされている状態をもって、MVPは完了とする。
- 画面に単色の背景が表示されている。
- 1匹の魚が、物理演算に基づいた滑らかなS字の動きで、画面内を自律的に泳ぎ続けている。
- 画面上のどこかをクリックすると、その位置に波紋が生成され、美しく広がって消える。
